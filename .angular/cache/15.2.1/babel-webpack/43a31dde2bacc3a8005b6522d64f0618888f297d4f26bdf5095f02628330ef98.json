{"ast":null,"code":"import _asyncToGenerator from \"/home/olivio-gits/programacionIV/Peliculas/peliculas/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { BehaviorSubject } from 'rxjs';\nimport firebase from 'firebase/compat/app';\nimport 'firebase/compat/auth';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/fire/compat/auth\";\nexport class DataServiceService {\n  constructor(http,\n  //requests\n  afAuth) {\n    this.http = http;\n    this.afAuth = afAuth;\n    this.initialState = {\n      peliculas: [],\n      user: {}\n    };\n    this.stateSubject = new BehaviorSubject(this.initialState); //definimos nuestro stateSubject\n    this.state$ = this.stateSubject.asObservable();\n  }\n  ngOnInit() {}\n  init() {\n    // Verificar si el usuario está autenticado\n    this.checkAuth();\n    // Escuchar los cambios en el estado del usuario\n    this.afAuth.authState.subscribe(user => {\n      if (user) {\n        const obj = {\n          name: user.displayName,\n          email: user.email,\n          image: user.photoURL\n        };\n        const currentState = this.stateSubject.value;\n        this.stateSubject.next({\n          ...currentState,\n          user: {\n            user: obj,\n            token: user.uid\n          }\n        });\n      } else {\n        const currentState = this.stateSubject.value;\n        this.stateSubject.next({\n          ...currentState,\n          user: null\n        });\n      }\n    });\n  }\n  checkAuth() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      const token = localStorage.getItem('authToken');\n      if (token) {\n        try {\n          const userCredential = yield firebase.auth().signInWithCustomToken(token);\n          const user = userCredential.user;\n          const obj = {\n            name: user?.displayName,\n            email: user?.email,\n            image: user?.photoURL\n          };\n          const currentState = _this.stateSubject.value;\n          _this.stateSubject.next({\n            ...currentState,\n            user: {\n              user: obj,\n              token: token\n            }\n          });\n        } catch (error) {\n          console.log('Error en la autenticación automática', error);\n        }\n      }\n    })();\n  }\n  signInWithGoogle() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      let obj;\n      const currentState = _this2.stateSubject.value;\n      const provider = new firebase.auth.GoogleAuthProvider();\n      _this2.afAuth.signInWithPopup(provider).then( /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* (result) {\n          console.log(result.user);\n          const token = result.user._delegate.stsTokenManager.accessToken; //recuperar token\n          if (result.user) {\n            obj = {\n              name: result.user.displayName,\n              email: result.user.email,\n              image: result.user.photoURL\n            };\n            yield localStorage.setItem('authToken', token); //guardar mi token\n            _this2.stateSubject.next({\n              ...currentState,\n              user: {\n                user: obj,\n                token: token\n              }\n            });\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    })();\n  }\n  signOut() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      const currentState = _this3.stateSubject.value;\n      yield _this3.afAuth.signOut();\n      // Eliminar token de localStorage y propiedad user del servicio\n      localStorage.removeItem('authToken');\n      _this3.stateSubject.next({\n        ...currentState,\n        user: {\n          user: 'null',\n          token: 'null'\n        }\n      });\n    })();\n  }\n}\nDataServiceService.ɵfac = function DataServiceService_Factory(t) {\n  return new (t || DataServiceService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.AngularFireAuth));\n};\nDataServiceService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: DataServiceService,\n  factory: DataServiceService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["BehaviorSubject","firebase","DataServiceService","constructor","http","afAuth","peliculas","user","initialState","stateSubject","asObservable","ngOnInit","init","checkAuth","authState","subscribe","obj","name","displayName","email","image","photoURL","currentState","value","next","token","uid","localStorage","getItem","userCredential","auth","signInWithCustomToken","error","console","log","signInWithGoogle","provider","GoogleAuthProvider","signInWithPopup","then","result","_delegate","stsTokenManager","accessToken","setItem","signOut","removeItem","factory","providedIn"],"sourceRoot":"","sources":["/home/olivio-gits/programacionIV/Peliculas/peliculas/src/app/services/data-service.service.ts"],"sourcesContent":["import { Injectable, OnInit } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { BehaviorSubject } from 'rxjs';\nimport firebase from 'firebase/compat/app';\nimport 'firebase/compat/auth';\nimport { AngularFireAuth } from '@angular/fire/compat/auth';\nimport { DataService } from '../models/modelService';\nimport { User } from '../models/modelUser';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class DataServiceService implements OnInit {\n\n  constructor(\n    private http:HttpClient, //requests\n    private afAuth: AngularFireAuth\n  ) {}\n\n  private initialState:DataService={ //definimos nuestro estado en base a nuestro modelo DataService\n    peliculas:[],\n    user:{}\n  }\n  private stateSubject = new BehaviorSubject<DataService>(this.initialState); //definimos nuestro stateSubject\n  state$ = this.stateSubject.asObservable();\n\n  ngOnInit() {\n  }\n  init() {\n    // Verificar si el usuario está autenticado\n    this.checkAuth();\n\n    // Escuchar los cambios en el estado del usuario\n    this.afAuth.authState.subscribe((user) => {\n      if (user) {\n        const obj: User = {\n          name: user.displayName,\n          email: user.email,\n          image: user.photoURL\n        };\n        const currentState = this.stateSubject.value;\n        this.stateSubject.next({\n          ...currentState,\n          user: {\n            user: obj,\n            token: user.uid\n          }\n        });\n      } else {\n        const currentState = this.stateSubject.value;\n        this.stateSubject.next({\n          ...currentState,\n          user: null\n        });\n      }\n    });\n  }\n  async checkAuth() {\n    const token = localStorage.getItem('authToken');\n    if (token) {\n      try {\n        const userCredential = await firebase.auth().signInWithCustomToken(token);\n        const user = userCredential.user;\n        const obj: User = {\n          name: user?.displayName,\n          email: user?.email,\n          image: user?.photoURL,\n        }\n        const currentState = this.stateSubject.value;\n        this.stateSubject.next({\n          ...currentState,\n          user:{\n            user: obj,\n            token: token\n          }\n        });\n      } catch (error) {\n        console.log('Error en la autenticación automática', error);\n      }\n    }\n  }\n\n  async signInWithGoogle() {\n    let obj:User;\n    const currentState = this.stateSubject.value;\n    const provider = new firebase.auth.GoogleAuthProvider();\n    this.afAuth.signInWithPopup(provider)\n    .then(async(result)=>{ //usuario logeado\n      console.log(result.user)\n      const token = (result.user as any)._delegate.stsTokenManager.accessToken; //recuperar token\n      if(result.user){\n        obj={\n          name: result.user.displayName,\n          email:result.user.email,\n          image:result.user.photoURL,\n        }\n        await localStorage.setItem('authToken', token); //guardar mi token\n        this.stateSubject.next({\n          ...currentState,\n          user:{\n            user: obj,\n            token: token\n          }\n        })  \n      }\n    }) \n  };\n\n  async signOut() {\n    const currentState = this.stateSubject.value;\n    await this.afAuth.signOut();\n    // Eliminar token de localStorage y propiedad user del servicio\n    localStorage.removeItem('authToken');\n    this.stateSubject.next({\n      ...currentState,\n      user:{\n        user:'null',\n        token:'null'\n      }\n    })\n  };\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}